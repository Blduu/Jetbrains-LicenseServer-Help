# 技术架构文档

本文档详细介绍 JetBrains License Server Help 的技术架构、系统设计、核心模块和数据流程。

## 📋 架构概述

JetBrains License Server Help 采用现代化的分层架构设计，基于 Spring Boot 4.0 框架构建，实现了 JetBrains 官方许可证服务器的 API 协议兼容，同时提供了产品/插件管理、证书管理、ja-netfilter 集成等功能。

### 1.1 架构分层

| 架构层次 | 主要职责 | 核心组件 |
|---------|---------|---------|
| 表现层 | 处理 HTTP 请求，提供 API 接口 | Controller 类 |
| 业务层 | 实现业务逻辑 | Service 类 |
| 数据访问层 | 数据加载与存储 | ContextHolder 类 |
| 工具层 | 提供通用工具支持 | Util 类 |
| 资源层 | 静态资源与配置文件 | HTML/CSS/JS、application.yml |

### 1.2 核心技术栈

| 技术类别 | 技术选型 | 版本 | 用途 |
|---------|---------|------|------|
| 后端框架 | Spring Boot | 4.0 | 应用开发框架 |
| 编程语言 | Java | 17 | 开发语言 |
| 构建工具 | Maven | 3.6+ | 项目构建与依赖管理 |
| 工具库 | Hutool | 5.8.28 | 通用工具类库 |
| 代码简化 | Lombok | 1.18.34 | 减少样板代码 |
| 加密库 | BouncyCastle | 1.78.1 | 密码学与证书处理 |
| XML 处理 | JAXB | - | XML 数据解析与生成 |
| 前端技术 | HTML5 + CSS3 + JavaScript | - | 前端页面开发 |
| 容器化 | Docker | - | 应用容器化部署 |

## 2. 核心模块架构

### 2.1 许可证服务器模拟模块

许可证服务器模拟模块是项目的核心功能，实现了与 JetBrains 官方许可证服务器兼容的 API 协议。

#### 2.1.1 模块架构

```
┌─────────────────────────┐     ┌─────────────────────────┐
│  LicenseServerController │────▶│  LicenseContextHolder   │
└─────────────────────────┘     └─────────────────────────┘
          ▲                              │
          │                              ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│  CertificateContextHolder │◀────│  LicenseServerUtils    │
└─────────────────────────┘     └─────────────────────────┘
```

#### 2.1.2 工作流程

1. 接收 JetBrains 产品的许可证请求
2. 验证请求参数的合法性
3. 生成唯一的许可证票据
4. 使用 RSA 私钥对响应数据进行签名
5. 返回符合官方格式的 XML 响应

### 2.2 产品与插件管理模块

产品与插件管理模块负责维护 JetBrains 产品和插件信息数据库，提供信息查询和定时更新功能。

#### 2.2.1 模块架构

```
┌─────────────────────────┐     ┌─────────────────────────┐
│  DataController         │────▶│  ProductsContextHolder  │
└─────────────────────────┘     └─────────────────────────┘
          ▲                              │
          │                              ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│  PluginsContextHolder   │◀────│  Product/Plugin JSON    │
└─────────────────────────┘     └─────────────────────────┘
          │
          ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│  PluginProcessService   │────▶│  PluginApiService       │
└─────────────────────────┘     └─────────────────────────┘
```

#### 2.2.2 工作流程

1. 应用启动时从 JSON 文件加载产品和插件信息
2. 提供 REST API 接口供前端和其他模块查询
3. 定时从 JetBrains 官方 API 更新插件信息
4. 将更新后的信息存储到 JSON 文件中

### 2.3 证书管理模块

证书管理模块负责生成和管理 RSA 密钥对和 X.509 证书，确保许可证数据的安全性。

#### 2.3.1 模块架构

```
┌─────────────────────────┐     ┌─────────────────────────┐
│  DataController         │────▶│  CertificateContextHolder│
└─────────────────────────┘     └─────────────────────────┘
          │                              │
          │                              ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│  Certificate Files      │◀────│  BouncyCastle API       │
└─────────────────────────┘     └─────────────────────────┘
```

#### 2.3.2 工作流程

1. 应用启动时检查密钥和证书文件是否存在
2. 如果不存在，自动生成 RSA 密钥对和 X.509 证书
3. 将密钥和证书存储到文件系统中
4. 提供 API 接口供其他模块获取证书信息

### 2.4 ja-netfilter 集成模块

ja-netfilter 集成模块提供 ja-netfilter 代理工具的下载和配置功能，用于辅助 JetBrains 产品的许可证验证。

#### 2.4.1 模块架构

```
┌─────────────────────────┐     ┌─────────────────────────┐
│  ZipController          │────▶│  AgentContextHolder     │
└─────────────────────────┘     └─────────────────────────┘
          │                              │
          │                              ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│  ja-netfilter.zip       │◀────│  Download Service       │
└─────────────────────────┘     └─────────────────────────┘
```

#### 2.4.2 工作流程

1. 从官方地址下载最新版本的 ja-netfilter 工具
2. 生成自定义的代理配置文件
3. 将 ja-netfilter 工具和配置文件打包成 ZIP 格式
4. 提供下载 API 接口供用户获取

### 2.5 可视化管理界面

可视化管理界面提供友好的 Web 界面，用于管理许可证、查询产品信息和下载 ja-netfilter 工具。

#### 2.5.1 模块架构

```
┌─────────────────────────┐     ┌─────────────────────────┐
│  Browser                │────▶│  Static Resources       │
└─────────────────────────┘     └─────────────────────────┘
          │                              │
          │                              ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│  JavaScript             │────▶│  REST API               │
└─────────────────────────┘     └─────────────────────────┘
```

#### 2.5.2 工作流程

1. 用户通过浏览器访问应用首页
2. 加载 HTML、CSS 和 JavaScript 静态资源
3. JavaScript 通过 REST API 与后端进行交互
4. 展示产品列表、插件列表和许可证信息

## 3. 数据流程

### 3.1 许可证请求处理流程

```
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│ JetBrains Product │────▶│ LicenseServer    │────▶│ LicenseContext   │
│                  │     │ Controller       │     │ Holder           │
└──────────────────┘     └──────────────────┘     └──────────────────┘
                                 │                         │
                                 ▼                         ▼
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│ XML Response     │◀────│ LicenseServer    │◀────│ Certificate      │
│                  │     │ Utils            │     │ Context Holder   │
└──────────────────┘     └──────────────────┘     └──────────────────┘
```

### 3.2 产品/插件信息加载流程

```
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│ Application      │────▶│ ProductsContext  │────▶│ product.json     │
│ Start            │     │ Holder           │     │                  │
└──────────────────┘     └──────────────────┘     └──────────────────┘
          │
          ▼
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│ PluginsContext   │────▶│ PluginProcess    │────▶│ JetBrains Plugin │
│ Holder           │     │ Service          │     │ API              │
└──────────────────┘     └──────────────────┘     └──────────────────┘
          │                         │
          ▼                         ▼
┌──────────────────┐     ┌──────────────────┐
│ plugin.json      │◀────│ PluginApiService │
│                  │     │                  │
└──────────────────┘     └──────────────────┘
```

### 3.3 ja-netfilter 下载流程

```
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│ User Browser     │────▶│ ZipController    │────▶│ AgentContext     │
│                  │     │                  │     │ Holder           │
└──────────────────┘     └──────────────────┘     └──────────────────┘
                                 │                         │
                                 ▼                         ▼
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│ ZIP File         │◀────│ FileTools        │◀────│ ja-netfilter     │
│                  │     │                  │     │ Download         │
└──────────────────┘     └──────────────────┘     └──────────────────┘
```

## 4. 系统架构图

```
┌────────────────────────────────────────────────────────────────────┐
│                        用户层                                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐           │
│  │ JetBrains   │     │ Web Browser │     │ REST Client │           │
│  │ 产品        │     │             │     │             │           │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘           │
│         │                   │                   │                   │
└─────────┼───────────────────┼───────────────────┼──────────────────┘
          │                   │                   │
┌─────────▼───────────────────▼───────────────────▼──────────────────┐
│                        表现层                                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐           │
│  │ LicenseServer│     │ DataController│     │ ZipController│         │
│  │ Controller  │     │             │     │             │           │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘           │
│         │                   │                   │                   │
└─────────┼───────────────────┼───────────────────┼──────────────────┘
          │                   │                   │
┌─────────▼───────────────────▼───────────────────▼──────────────────┐
│                        业务层                                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐           │
│  │ LicenseContext│    │ ProductsContext│    │ PluginsContext│        │
│  │ Holder       │    │ Holder       │    │ Holder       │           │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘           │
│         │                   │                   │                   │
│  ┌──────▼──────┐     ┌──────▼──────┐     ┌──────▼──────┐           │
│  │ Certificate │     │ AgentContext│     │ PluginProcess│           │
│  │ ContextHolder│    │ Holder      │    │ Service      │           │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘           │
│         │                   │                   │                   │
└─────────┼───────────────────┼───────────────────┼──────────────────┘
          │                   │                   │
┌─────────▼───────────────────▼───────────────────▼──────────────────┐
│                        数据层                                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐           │
│  │ product.json│     │ plugin.json │     │ Certificate │           │
│  │             │     │             │     │ Files        │           │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘           │
│         │                   │                   │                   │
└─────────┼───────────────────┼───────────────────┼──────────────────┘
          │                   │                   │
┌─────────▼───────────────────▼───────────────────▼──────────────────┐
│                        工具层                                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐           │
│  │ LicenseServer│     │ FileTools   │     │ JAXB Utils  │           │
│  │ Utils        │     │             │     │             │           │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘           │
│         │                   │                   │                   │
└─────────┼───────────────────┼───────────────────┼──────────────────┘
          │                   │                   │
┌─────────▼───────────────────▼───────────────────▼──────────────────┐
│                        资源层                                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐           │
│  │ HTML/CSS/JS │     │ application.yml│   │ logback-spring.xml│    │
│  │             │     │             │     │             │           │
│  └─────────────┘     └─────────────┘     └─────────────┘           │
└────────────────────────────────────────────────────────────────────┘
```

## 5. 核心组件设计

### 5.1 Controller 组件

#### 5.1.1 LicenseServerController

- **职责**：处理 JetBrains 产品的许可证请求
- **核心方法**：
  - `obtainTicket()`：获取许可证票据
  - `prolongTicket()`：延长许可证票据有效期
  - `releaseTicket()`：释放许可证票据
  - `ping()`：检查服务器状态

#### 5.1.2 DataController

- **职责**：提供产品、插件和证书信息的查询接口
- **核心方法**：
  - `getProducts()`：获取产品列表
  - `getPlugins()`：获取插件列表
  - `getCertificate()`：获取证书信息
  - `getSystemInfo()`：获取系统信息

#### 5.1.3 ZipController

- **职责**：提供文件下载功能
- **核心方法**：
  - `getJaNetfilter()`：下载 ja-netfilter 工具
  - `getLicenseFiles()`：下载许可证文件

### 5.2 ContextHolder 组件

#### 5.2.1 LicenseContextHolder

- **职责**：管理许可证相关的上下文信息
- **核心功能**：
  - 生成唯一的服务器 UID
  - 管理许可证租期和验证周期
  - 提供许可证票据生成服务

#### 5.2.2 ProductsContextHolder

- **职责**：管理 JetBrains 产品信息
- **核心功能**：
  - 从 JSON 文件加载产品信息
  - 提供产品信息查询接口
  - 支持产品信息的定时更新

#### 5.2.3 PluginsContextHolder

- **职责**：管理 JetBrains 插件信息
- **核心功能**：
  - 从 JSON 文件加载插件信息
  - 提供插件信息查询接口
  - 支持插件信息的定时更新

#### 5.2.4 CertificateContextHolder

- **职责**：管理 RSA 密钥对和 X.509 证书
- **核心功能**：
  - 生成 RSA 密钥对
  - 创建 X.509 证书
  - 存储和加载密钥与证书

#### 5.2.5 AgentContextHolder

- **职责**：管理 ja-netfilter 代理工具
- **核心功能**：
  - 下载 ja-netfilter 工具
  - 生成代理配置文件
  - 打包和提供下载服务

### 5.3 Service 组件

#### 5.3.1 PluginProcessService

- **职责**：处理插件信息的定时更新
- **核心功能**：
  - 调用 JetBrains 官方 API 获取插件信息
  - 多线程处理插件数据
  - 更新插件信息到 JSON 文件

#### 5.3.2 PluginApiService

- **职责**：与 JetBrains 插件 API 进行交互
- **核心功能**：
  - 发送 HTTP 请求获取插件列表
  - 解析 API 响应数据
  - 转换为内部数据结构

#### 5.3.3 JrebelService

- **职责**：提供 JRebel 相关的功能
- **核心功能**：
  - JRebel 许可证生成
  - JRebel 许可证签名

### 5.4 Util 组件

#### 5.4.1 LicenseServerUtils

- **职责**：提供许可证服务器相关的工具方法
- **核心功能**：
  - XML 响应生成
  - RSA 签名和验证
  - 许可证票据处理

#### 5.4.2 FileTools

- **职责**：提供文件操作相关的工具方法
- **核心功能**：
  - 文件读写
  - ZIP 打包和解压
  - 目录操作

## 6. 配置管理

项目使用 Spring Boot 的配置文件机制，主要配置文件为 `application.yml`，包含以下配置项：

### 6.1 服务器配置

```yaml
server:
  port: 10768  # 服务器端口
```

### 6.2 许可证服务器配置

```yaml
help:
  license:
    server-uid: "12345678-1234-1234-1234-123456789012"  # 服务器唯一标识符
    lease-duration: 365  # 租期有效期（天）
    validation-period: 600000  # 验证周期（毫秒）
```

### 6.3 产品配置

```yaml
help:
  products:
    refresh-enabled: true  # 是否启用产品信息刷新
    refresh-interval: 86400000  # 刷新间隔（毫秒）
```

### 6.4 插件配置

```yaml
help:
  plugins:
    refresh-enabled: true  # 是否启用插件信息刷新
    refresh-cron: "0 0 12 * * ?"  # 刷新时间
    page-size: 20  # 页面大小
    thread-count: 5  # 并发线程数
    timeout: 30000  # 请求超时（毫秒）
```

### 6.5 ja-netfilter 配置

```yaml
help:
  agent:
    enabled: true  # 是否启用 ja-netfilter 集成
    download-url: "https://github.com/ja-netfilter/ja-netfilter/releases/latest/download/ja-netfilter.zip"  # 下载 URL
    config-dir: "agent/config"  # 配置目录
```

### 6.6 证书配置

```yaml
help:
  certificate:
    key-size: 2048  # 密钥大小
    validity: 3650  # 证书有效期（天）
    alias: "license-server"  # 证书别名
    keystore-password: "password"  # 密钥库密码
```

## 7. 技术选型理由

### 7.1 Spring Boot

- **理由**：提供了快速开发的框架支持，简化了配置和部署流程
- **优势**：自动配置、嵌入式服务器、丰富的生态系统

### 7.2 Java 17

- **理由**：提供了现代 Java 的特性支持，同时保持了良好的性能和稳定性
- **优势**：增强的类型推断、密封类、模式匹配等新特性

### 7.3 Maven

- **理由**：成熟的构建工具，提供了丰富的插件和依赖管理功能
- **优势**：标准化的构建流程、依赖版本管理、多模块支持

### 7.4 Hutool

- **理由**：提供了丰富的工具类，简化了开发工作
- **优势**：功能全面、API 友好、易于使用

### 7.5 BouncyCastle

- **理由**：提供了强大的密码学支持，满足证书生成和签名需求
- **优势**：支持多种加密算法、丰富的证书处理功能

### 7.6 前端技术栈（HTML5 + CSS3 + JavaScript）

- **理由**：轻量级的前端技术栈，满足简单的可视化管理需求
- **优势**：无需额外的构建工具、加载速度快、易于维护

## 8. 扩展性设计

### 8.1 模块扩展

项目采用了模块化的设计，各个功能模块之间通过接口进行交互，便于后续扩展新的功能模块。

### 8.2 配置扩展

使用 Spring Boot 的配置文件机制，支持通过配置文件扩展和定制功能，无需修改代码。

### 8.3 API 扩展

提供了 REST API 接口，便于与其他系统进行集成和扩展。

### 8.4 数据扩展

采用 JSON 文件存储数据，便于后续扩展到数据库存储。

## 9. 安全性设计

### 9.1 数据加密

- 使用 RSA 密钥对和 X.509 证书对许可证数据进行签名，确保数据的完整性和真实性

### 9.2 访问控制

- 提供了简单的访问控制机制，限制敏感 API 的访问

### 9.3 输入验证

- 对所有输入参数进行验证，防止恶意输入和攻击

### 9.4 安全配置

- 支持 HTTPS 配置，确保数据传输的安全性

## 10. 性能优化

### 10.1 缓存机制

- 对产品和插件信息进行缓存，减少文件读取和网络请求

### 10.2 多线程处理

- 使用多线程处理插件信息的更新，提高处理效率

### 10.3 延迟加载

- 采用延迟加载机制，仅在需要时加载相关资源

### 10.4 连接池

- 使用连接池管理 HTTP 连接，减少连接建立的开销

## 11. 总结

JetBrains License Server Help 采用了现代化的分层架构设计，基于 Spring Boot 4.0 框架构建，实现了与 JetBrains 官方许可证服务器兼容的 API 协议，同时提供了产品/插件管理、证书管理、ja-netfilter 集成等功能。项目具有良好的扩展性、安全性和性能优化，满足了用户的需求。